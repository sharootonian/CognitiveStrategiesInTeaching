<!DOCTYPE html>
<html>
  <head>
    <title>Node Graph Example</title>
    <script src="../../shared/js/lib/jspsych/jspsych.js"></script>
    <!-- Include plugin-external-html.js from jspsych library to print text on the screen -->
    <script src="../../shared/js/lib/jspsych/plugin-external-html.js"></script>
    <!-- Include necessary scripts from AnyChart library for drawing graphs -->
    <script src="https://cdn.anychart.com/releases/8.9.0/js/anychart-core.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.9.0/js/anychart-graph.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.9.0/js/anychart-data-adapter.min.js"></script>
  </head>                                                         
  <body>
    <!-- Header elements with a center alignment -->
    <h1 id="heading2" style="text-align:center">This is a new student.</h1>
    <h2 id="heading3" style="text-align:center">You have 30 seconds to select <u>one</u> edge to teach.</h2>
    <!-- Container for the graph -->
    <div id="container" style="margin: auto; width: 500px; height: 500px;"></div>
    <!-- Container for the checkbox and the button -->
    <div id="consent" style="margin:auto; width: 300px">
      <p>
        <input type="checkbox" id="selected" />
      </p>
      <div style="margin:auto; width:150px">
        <button type="button" id="next_trial">Next student</button>
      </div>
    </div>
  </body>
  <script>
    // Initializing checkbox to be disabled and hidden
    document.getElementById("selected").disabled = "disabled";
    document.getElementById("selected").style.display = "none";
    
    // Adding event listener to the button to call the checkValue function when clicked

    document.getElementById("next_trial").addEventListener("click", checkSkip, false);

    // Adding event listener to the button to call the skipTrial function after 30 seconds
    var timer = false;
    delay = 30000;
    var timeoutId = setTimeout(function () {
      timer = true;
      next_trial.click();
    }, delay);

    // Get the indexInput value from sessionStorage or set it to 0 if it's not available
    var temp = sessionStorage.getItem("indexInput");
    var indexInput = 0;
    if (temp !== null) {
      indexInput = parseInt(temp,10);
    }
    setUpCsvGraph(parseInt(indexInput));
    

    // Function to check if an edge has been selected
    function skipTrial() {
      sessionStorage.setItem("skipped", true);
      indexInput++;
      sessionStorage.setItem("indexInput","" + indexInput);
      setUpCheckBox();
      timer = false;
      return false;
    }

    function checkSkip() {
      if (timer) {
        clearTimeout(timeoutId);
        skipTrial()
      } else {
        checkValue();
      }
    }

    // Function to check if an edge has been selected
    function checkValue() {
      var edgeSelected = sessionStorage.getItem("edgeSelection");
      if (edgeSelected == "") {
          document.getElementById("selected").checked = false;
          return false;
      } else {
        var edgeStr = "edgeSelection_" + indexInput.toString();
        sessionStorage.setItem(edgeStr, edgeSelected);
        sessionStorage.setItem("skipped", false);
        indexInput++;
        sessionStorage.setItem("indexInput","" + indexInput);
        setUpCheckBox();
        clearTimeout(timeoutId);
        return false;
      }
      return true;
    }
    // function to check if an edge has been selected 
    // 0: "11to8" 1: "11to9" 2: "11to10"3: "8to5" 4: "8to6" 5: "9to5" 6: "9to6" 7: "9to7" 8: "10to6" 9: "10to7" 10: "5to2"
    // 11: "5to3" 12: "6to2" 13: "6to3" 14: "6to4" 15: "7to3" 16: "7to4" 17: "2"
    // 18: "3" 19: "4" 20: "5" 21: "6" 22: "7" 23: "8" 24: "9" 25: "10" 26: "11"
    function makeNextGraph(csvArray, index) {   
      var edges = [];
      var groupNames = ["zeroth","first", "second", "third"];
      var currData = csvArray[index];

      var node = [
        {id: "0", x: 0, y: -80, group: groupNames[parseInt(currData["0"])]},
        {id: "1", x: -150, y: 46, group: groupNames[parseInt(currData["1"])]},
        {id: "2", x: 0, y: 46, group: groupNames[parseInt(currData["2"])]},
        {id: "3", x: 150, y: 46, group: groupNames[parseInt(currData["3"])]},
        {id: "4", x: -150, y: 172, group: groupNames[parseInt(currData["4"])]},
        {id: "5", x: 0, y: 172, group: groupNames[parseInt(currData["5"])]},
        {id: "6", x: 150, y: 172, group: groupNames[parseInt(currData["6"])]},
        {id: "7", x: -150, y: 298, group: groupNames[parseInt(currData["7"])]},
        {id: "8", x: 0, y: 298, group: groupNames[parseInt(currData["8"])]},
        {id: "9", x: 150, y: 298, group: groupNames[parseInt(currData["9"])]},
      ];
      
      var edgelistSample = [
        {from:'0', to: "1", id: "0to1", normal: {stroke:  {color: "#8b8b8b", thickness: "5", dash: "15 5",}} , selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: '0', to: "2", id: "0to2", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: '0', to: "3", id: "0to3", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: "1", to: "4", id: "1to4", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: "1", to: "5", id: "1to5", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: "2", to: "4", id: "2to4", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: "2", to: "5", id: "2to5", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: "2", to: "6", id: "2to6", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: "3", to: "5", id: "3to5", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: "3", to: "6", id: "3to6", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: "4", to: "7", id: "4to7", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: "4", to: "8", id: "4to8", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: "5", to: "7", id: "5to7", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: "5", to: "8", id: "5to8", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: "5", to: "9", id: "5to9", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: "6", to: "8", id: "6to8", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
        {from: "6", to: "9", id: "6to9", normal: {stroke: {color: "#8b8b8b", thickness: "5", dash: "15 5",}}, selected: {stroke: "8 #ffb000"}, hovered: {stroke: "5 #8b8b8b"}},
      ];
      var edgeNames = ["0to1", "0to2", "0to3", "1to4", "1to5", "2to4", "2to5", "2to6", "3to5","3to6", "4to7", "4to8", "5to7", "5to8", "5to9", "6to8", "6to9"];

      for (let i = 0; i <= edgeNames.length; i++) {
        var edgeVar = edgelistSample[i]
        if (currData[edgeNames[i]] == "True") {
          edgeVar.normal = {stroke: "8 #000000"}
          edgeVar.hovered = {stroke: "8 #6495ED"}
          edgeVar.selected = {stroke: "8 #ffb000"}
        }
        edges.push(edgeVar)
      };

      return [node, edges]
    };

    // link below:
    // https://api.anychart.com/v8/anychart.charts.Graph#labels
    // MAKES NODES GRAPH USING PLUGIN:
    function showGraph(dataInput){
      var chart = anychart.graph(dataInput);
      //licance
      // anychart.licenseKey() removed for public demo - will show AnyChart watermark;
      var credits = chart.credits();
      credits.enabled(false);
      chart.container("container");
      chart.interactivity().enabled(false);//prevents it from moving

      // set the layout type
      chart.layout().type("fixed");

      // makes it a specific size
      chart.nodes().normal().height(50);
      chart.nodes().hovered().height(50);
      chart.nodes().selected().height(50);
      chart.nodes().normal().stroke('Black',2);
      chart.nodes().hovered().stroke('Black',2);
      chart.nodes().selected().stroke('Black',2);

      // makes hover label not show up
      chart.nodes().tooltip().enabled(false);
      chart.edges().tooltip().enabled(false);

      // adds colors to groups
      // var colorList = ['#808000','#e69090', "#d85f5f", "#B22222", "#800000"];
      var colorList = ['#FFF5F0','#e0a994', "#e37f6b", "#FF0000"];
      //var colorList = ['#ffffff','#fe6100', "#dc267f", "#785ef0"];
      var zeroth = chart.group("zeroth");
      var first = chart.group("first");
      var second = chart.group("second");
      var third = chart.group("third");
      // var fourth = chart.group("fourth");

      // enable the labels of nodes
      chart.nodes().labels().enabled(true);
      chart.nodes().labels().fontColor("White");
      chart.nodes().labels().position("center").anchor('center');
  
      if (zeroth != null) {
        zeroth.fill(colorList[0]);
        chart.group("zeroth").labels().fontColor("Black");
        chart.group("zeroth").labels().format("0");
        chart.group("zeroth").labels().fontSize(20);
        chart.group("zeroth").labels().fontWeight(600);
      }

      if (first != null) {
        first.fill(colorList[1]);
        chart.group("first").labels().format("+1");
        chart.group("first").labels().fontSize(20);
        chart.group("first").labels().fontWeight(600);
      }
      if (second != null) {
        second.fill(colorList[2]);
        chart.group("second").labels().format("+2");
        chart.group("second").labels().fontSize(20);
        chart.group("second").labels().fontWeight(600);
      }
      if (third != null) {
        third.fill(colorList[3]);
        chart.group("third").labels().format("+3");
        chart.group("third").labels().fontSize(20);
        chart.group("third").labels().fontWeight(600);
      }

      //return chart;
      return chart;
    };

    function setUpCsvGraph(index) {
      // GETS CSV FROM SESSION STORAGE
      var csvArr = JSON.parse(localStorage.getItem("csvArr"));
      
      var ret = makeNextGraph(csvArr, index);
      var dataCsv = {
            nodes: ret[0],
            edges: ret[1],
          };
      
      var chart = showGraph(dataCsv)
      var madeChartCsv = chart.draw()

      // reaction time stuffer
      var stimulusOnsetTimeMS = Date.now()
      var responsesLog = [];
      var currEdgeRTMS = undefined
      sessionStorage.setItem("responsesLog", responsesLog);
      sessionStorage.setItem("edgeRTMS", currEdgeRTMS);
      // clears session storage
      var currEdgeSelection = "";// going to be passed back to main with selected edge variable
      sessionStorage.setItem("edgeSelection", currEdgeSelection);

      madeChartCsv.listen('click', function(e) {
          var tag = e.domTarget.tag;
          if (tag) {
              // console.log(`Clicked ${tag.type} with ID ${tag.id}`);

              if (tag.type === 'edge') {
                  // example: https://playground.anychart.com/VEKKIOFF/1
                  // just updates saved edge selection variable
                  currEdgeSelection = tag.id;
                  // console.log(currEdgeSelection);
                  currEdgeRTMS = Date.now() - stimulusOnsetTimeMS
                  responsesLog.push({edgeSelection: currEdgeSelection, edgeRTMS: currEdgeRTMS})
                  sessionStorage.setItem("responsesLog", JSON.stringify(responsesLog));
                  sessionStorage.setItem("edgeRTMS", currEdgeRTMS);
                  sessionStorage.setItem("edgeSelection", currEdgeSelection);
              } else if (tag.type === 'node') {
                //TRY TO MAKE NODE NOT VISIBLY CLICKED HERE
                alert("Please select an individual dotted line. A group of lines or a circle will not be considered.")
                chart.unselect();
              }
          }
      });
    }

    function setUpCheckBox() {
      // add these to database either at the end or along the way
      // console.log("here are the selections: ")
      for (let i = 0; i <= indexInput; i++) {
        // console.log(sessionStorage.getItem("edgeSelection_" + i))
      }
      // makes checkbox clickable, which returns to jspsych
      document.getElementById("selected").disabled = "enabled"
      document.getElementById("selected").checked = true;
    }
  </script>
</html>