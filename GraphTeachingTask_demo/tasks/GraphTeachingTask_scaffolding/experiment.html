<!DOCTYPE html>
<html>
<head>
  <title>Path Improvement</title>

  <!-- Load required libraries -->
  <script src="../../shared/js/lib/jquery-3.3.1/jquery.min.js"></script>
  <script src="../../shared/js/lib/jspsych/jspsych.js"></script>

  <!-- Load your custom jspsych plugin -->
  <script src="../../shared/js/plugin-external-html-edgeRes.js" type="text/javascript"></script>

  <!-- Load jspsych plugins -->
  <script src="../../shared/js/lib/jspsych/plugin-html-keyboard-response.js"></script>
  <script src="../../shared/js/lib/jspsych/plugin-instructions.js"></script>
  <script src="../../shared/js/lib/jspsych/plugin-fullscreen.js"></script>
  <script src="../../shared/js/lib/jspsych/plugin-survey-multi-choice.js"></script>
  <script src="../../shared/js/lib/jspsych/plugin-survey.js"></script>
  <script src="../../shared/js/lib/jspsych/plugin-preload.js"></script>
  
  <!-- Load anychart library for charting capabilities -->
  <script src="https://cdn.anychart.com/releases/8.9.0/js/anychart-core.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.9.0/js/anychart-graph.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.9.0/js/anychart-data-adapter.min.js"></script>

  <!-- Load CSS styles for jspsych and your survey -->
  <link href="../../shared/css/jspsych.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="https://unpkg.com/@jspsych/plugin-survey@0.1.1/css/survey.css">

</head>
<body>
  <!-- The div where jsPsych will render the experiment -->
  <div id="jspsych-target"></div>
</body>
<script>
  // Get condition from URL parameter
  const urlParams = new URLSearchParams(window.location.search);
  const selectedOption = urlParams.get('condition') || 'normal'; // Default to normal if not specified

  //console.log(selectedOption)
  var ntrials = 20
  var ntraining_trials = 20

  sessionStorage.setItem("ntrials", ntrials)
  // Set the chosen script as a global variable
  window.selectedScript = selectedOption;
</script>
<script>
  if (window.selectedScript === 'scaffolding') {
      document.write('<script src="../../shared/js/exp3_scaffolding.js"><\/script>');
  } else if (window.selectedScript === 'distractor') {
      document.write('<script src="../../shared/js/exp3_distractor.js"><\/script>');
  } else {
      document.write('<script src="../../shared/js/exp3_normal.js"><\/script>');
  }
</script>
<!-- This script module handles the experiment setup, data loading and experiment running -->
<script type="module">
  import {csv} from "https://cdn.skypack.dev/d3-fetch@3"; // import d3-fetch for csv file handling
  const CI_path = "../../shared/data/exp3_trialsetup_CI.csv"
  const II_path = "../../shared/data/exp3_trialsetup_II.csv"

  // Get congruency from URL parameter
  const urlParams2 = new URLSearchParams(window.location.search);
  const congruency = urlParams2.get('congruency') || 'CI'; // Default to CI if not specified

  var csvArr = [] // array to hold the data from the CSV file
  const csvFile = congruency === 'II' ? II_path : CI_path;

  // Load the data from the CSV file
  csv(csvFile).then((dataRes) => {
    csvArr = dataRes; // save the data in the csvArr array
      
    // clear any existing session storage
    localStorage.clear();
    sessionStorage.clear()

    // var unshuffled = csvArr
    var unshuffled_training = csvArr.slice(0,ntraining_trials);
    var unshuffled_test = csvArr.slice(ntraining_trials,ntrials)

    // shuffle the csv here
    /*let shuffled_training = unshuffled_training
      .map(value => ({ value, sort: Math.random() }))
      .sort((a, b) => a.sort - b.sort)
      .map(({ value }) => value)
    */

    ////*************************************** CCII
    var combined = unshuffled_training.concat(unshuffled_test)

      ////*************************************** IIII
      // let shuffled2x_incongruent = shuffled_incongruent
      //   .map(value => ({ value, sort: Math.random() }))
      //   .sort((a, b) => a.sort - b.sort)
      //   .map(({ value }) => value)
      // var combined = shuffled_incongruent.concat(shuffled2x_incongruent)

    // saves new shuffled indices in session storage 
    var shuffledIndices = []
    var congruency = []
    var flipped = []
    var trial_id = []
    var trial_group = []

    combined.forEach(row => {
      // ...use `row`...
      shuffledIndices.push(row["index"])
      flipped.push(row["flipped"])
      congruency.push(row["congruency"])
      trial_id.push(row["trial_id"])
      trial_group.push(row["trial_group"])
    });

  localStorage.setItem("shuffledIndices", JSON.stringify(shuffledIndices))
  localStorage.setItem("flipped", JSON.stringify(flipped))
  localStorage.setItem("congruency", JSON.stringify(congruency))
  localStorage.setItem("trial_id", JSON.stringify(trial_id))
  localStorage.setItem("trial_group", JSON.stringify(trial_group))
  const arrayOfStrings = new Array(trial_id.length).fill(selectedOption);  

  localStorage.setItem("condition", JSON.stringify(arrayOfStrings));
    // sets items
  localStorage.setItem("csvArr", JSON.stringify(combined));
  // localStorage.setItem("csvArr", JSON.stringify(csvArr));
  localStorage.setItem("indexInput","0")

    // console.l("csvArr")
    // console.l(csvArr[0])
    // console.l(shuffled[0])
  });
  //console.log(window.selectedScript,csvFile )
  timeline.push(enter_fullscreen);
  timeline.push(welcome);
  timeline.push(instructions);
  timeline.push(trainingInteractive)
  timeline.push(quiz)
  timeline.push(quiz_failed);
  timeline.push(breaktime);
  timeline.push(experiment_reminder);
  timeline.push(experimentF_procedure);
  timeline.push(debrief);
  timeline.push(conclusion);

  // runs experiment
  jsPsych.run(timeline)
// OUTCODE END


</script>
<script>
  // Pass message from jsPsych to NivTurk
  function pass_message(msg) {

    $.ajax({
      url: "/experiment",
      method: 'POST',
      data: JSON.stringify(msg),
      contentType: "application/json; charset=utf-8",
    }).done(function(data, textStatus, jqXHR) {
      // do nothing on success
    }).fail(function(error) {
      console.log(error);
    });

  }

  // Save an incomplete dataset.
  function incomplete_save() {

    $.ajax({
      url: "/incomplete_save",
      method: 'POST',
      data: JSON.stringify(jsPsych.data.get().json()),
      contentType: "application/json; charset=utf-8",
    }).done(function(data, textStatus, jqXHR) {
      // do nothing
    }).fail(function(error) {
      // do nothing
    });

  }

  // Demo mode - no data collection or redirects needed

</script>
</html>